# タスク管理機能

締切に紐づくタスクの管理と、Today's Task（今日の優先タスク）の自動選定を行う機能。

**参照実装**:
- `src/app/tasks/page.tsx` — タスク一覧ページ
- `src/hooks/useTasks.ts` — タスク管理フック
- `src/app/api/tasks/` — タスクAPI
- `src/components/dashboard/IncompleteTasksCard.tsx` — ダッシュボード連携

---

## 1. 概要

| 項目 | 内容 |
|------|------|
| **タスクタイプ** | 6種（ES作成、WEBテスト、自己分析、ガクチカ、動画・録画、その他） |
| **ステータス** | `open` / `done` |
| **自動生成** | 締切作成時にタスクを自動生成（`isAutoGenerated: true`） |
| **Today's Task** | 締切3日以内のタスクまたは進行中ガクチカを優先表示 |
| **ゲスト対応** | デバイストークンによるゲストユーザーサポート |

---

## 2. タスクタイプ

| ID | 日本語名 | バッジ色 |
|----|---------|---------|
| `es` | ES作成 | 青（blue） |
| `web_test` | WEBテスト | 紫（purple） |
| `self_analysis` | 自己分析 | エメラルド（emerald） |
| `gakuchika` | ガクチカ | 琥珀（amber） |
| `video` | 動画・録画 | ピンク（pink） |
| `other` | その他 | グレー（gray） |

---

## 3. Today's Task 選択ロジック

`GET /api/tasks/today` で今日の優先タスクを決定する。

```
1. DEADLINE モード: 締切まで0〜3日のopenタスクを検索
   → 最も期限が近いタスクを返却
   → メッセージ例: "締切が近づいています"

2. DEEP_DIVE モード: ガクチカ（in_progress）を検索
   → 進行中のガクチカタスクを返却
   → メッセージ例: "深掘りを続けましょう"

3. 該当なし: { mode: null, task: null }
```

---

## 4. 締切からの自動タスク生成

```
締切が作成・更新される
  ↓
バックエンドが対応するタスクを自動生成（isAutoGenerated: true）
  → deadlineId でリレーション
  ↓
締切完了時
  → 紐づく自動生成タスクも自動で done に更新
  → deadline.autoCompletedTaskIds に記録
```

---

## 5. タスク一覧ページ UI

### ヘッダー
- Today's Task セクション（星アイコン + 優先度インジケータ）
- タイプバッジ + 企業リンク + 締切カウントダウン

### フィルタータブ
- すべて（全件数） | 未完了（open件数） | 完了（done件数）

### タスク行
- チェックボックス（円形トグル）
- タイプバッジ（色分け）
- 企業リンク（任意）
- 期限表示（「今日」「明日」「あと N 日」「期限切れ」）
- 説明プレビュー（2行クランプ）
- 完了タスク: 取り消し線 + 透明度ダウン
- 期限切れ: 赤背景 (`red-50`) + 赤ボーダー

### モーダル（作成/編集）
- タイトル（必須）、説明、タイプ（6選択肢）、期限日
- 削除ボタン（編集時のみ、確認ダイアログ付き）

---

## 6. DBテーブル

### `tasks`

| カラム | 型 | 説明 |
|--------|-----|------|
| `userId` / `guestId` | `text (FK)` | オーナー（XOR制約） |
| `companyId` | `text (FK)` | 関連企業 |
| `applicationId` | `text (FK)` | 関連選考 |
| `deadlineId` | `text (FK)` | 関連締切 |
| `title` | `text` | タスクタイトル |
| `description` | `text` | 説明（任意） |
| `type` | `enum` | タスクタイプ（6種） |
| `status` | `"open" \| "done"` | ステータス |
| `dueDate` | `timestamptz` | 期限日 |
| `isAutoGenerated` | `boolean` | 自動生成フラグ |
| `sortOrder` | `integer` | 並び順 |
| `completedAt` | `timestamptz` | 完了日時 |

**インデックス**: `user_status_due`, `guest_status_due`, `company`, `application`, `deadline`, `status`

---

## 7. APIルート

| メソッド | エンドポイント | 説明 |
|----------|---------------|------|
| GET | `/api/tasks` | タスク一覧（フィルタ: `status`, `companyId`, `applicationId`） |
| POST | `/api/tasks` | タスク作成 |
| PUT | `/api/tasks/[id]` | タスク更新（部分更新対応） |
| DELETE | `/api/tasks/[id]` | タスク削除 |
| GET | `/api/tasks/today` | Today's Task 取得 |

---

## 8. フック

### `useTasks(options)`

| オプション | 型 | 説明 |
|-----------|-----|------|
| `status` | `"open" \| "done" \| "all"` | ステータスフィルタ |
| `companyId` | `string` | 企業フィルタ |
| `applicationId` | `string` | 選考フィルタ |

**返却**: `{ tasks, isLoading, error, refresh, createTask, updateTask, deleteTask, toggleComplete }`

### `useTodayTask()`

**返却**: `{ mode, task, message, isLoading, error, refresh, markComplete }`

---

## 9. UX設計

### 緊急度の視覚表現
- **赤** (`< 3日`): 背景赤 + 赤ボーダー
- **オレンジ** (`3〜7日`): 警告色
- **エメラルド** (`> 7日`): 通常

### 心理的テクニック
- **ツァイガルニク効果**: 未完了タスクを「作業途中」セクションでハイライト
- **ポジティブ強化**: 空状態で「すべて完了！」メッセージ

---

## 関連ファイル

| ファイル | 役割 |
|----------|------|
| `src/app/tasks/page.tsx` | タスク一覧ページ（550行） |
| `src/hooks/useTasks.ts` | タスクフック（307行） |
| `src/app/api/tasks/route.ts` | タスクCRUD API |
| `src/app/api/tasks/[id]/route.ts` | タスク個別操作API |
| `src/app/api/tasks/today/route.ts` | Today's Task API |
| `src/components/dashboard/IncompleteTasksCard.tsx` | ダッシュボード未完了タスクカード |
| `src/lib/db/schema.ts` | DBスキーマ（`tasks`） |
