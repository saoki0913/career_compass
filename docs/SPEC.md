# 機能詳細

## 0. 目的・ターゲット・スコープ

### 0.1 目的
就活塾に行かない不安層に対して、AIと進捗管理で「安価に、迷わず、締切を落とさず、ESの品質を上げる」ことを実現する。

### 0.2 ターゲット
- 情報弱者寄り、就活塾回避層
- 外資投資銀行/戦略コンサル/総合商社など超高難度層は主ターゲットではない

### 0.3 MVPに含む（機能）
- ES自動添削（スコア/Top3/リライト、反映UX、全文添削はコピーのみ）
- ガクチカ深掘りBot（MVPとして搭載）
- 進捗管理（企業登録→公式情報抽出→締切承認→通知→タスク提案）
- ES作成ドキュメント（保存・企業/応募枠紐づけ）
- ESテンプレ共有/ギャラリー
- 企業登録（公式採用ページ候補提示＋手動URL貼付フォールバック）
- 企業情報抽出（根拠URLと信頼度表示、締切のみ承認必須）
- カレンダー連携（Google/アプリ内、提案→承認→追加、freebusy空き時間計算）
- クレジット（成功時のみ消費、企業更新の無料回数、月次付与、ES添削上限5）
- 高度なRAG（MVPは「取得・保存・上限管理・未取得分岐」まで）

### 0.4 MVPから除外（明示）
- 企業別攻略カード
- コミュニティ（初期は閲覧主役で低優先）

---

## 1. 非機能仕様（ユーザー体験に影響する前提）

### 1.1 タイムゾーン
- 日次通知、無料回数リセット等の境界は **JST（Asia/Tokyo）** を基準とする。
- ユーザー表示もJSTで統一する。

### 1.2 成功時のみ消費（絶対条件）
- 企業情報の取得/更新、ES添削は **成功時のみ** クレジット消費する。
- 企業更新の無料回数（ログインは1日3回/ゲストは2回）も **成功時のみ** カウントする（失敗は消費・カウント無し）。

### 1.3 非同期化（ユーザー向け挙動）
- 外部I/O（企業ページ取得、LLM添削、Googleカレンダー書き込み）は「実行開始→結果通知」の非同期体験とする。
- ユーザーには以下が見えること:
  - 実行開始トースト
  - 実行結果（成功/失敗・消費量・無料枠使用有無）が通知欄に履歴として残る
  - 処理中状態が分かる（"処理中…"の表示）
- 失敗時は可能な範囲で具体的な原因を表示する
- 自動再試行は行わず、ユーザーが手動で再実行する

### 1.4 パフォーマンス要件
- ES添削・企業情報取得の応答時間目標は設けない（完了まで待機）
- 処理中はプログレス表示で対応

### 1.5 セッション管理
- セッションタイムアウト: **7日間**操作なしでログアウト
- ES編集中のデータ保護: ローカル保存で対応

### 1.6 オフライン対応
- 対応レベル: **編集のみ**
- ES編集中のテキストはローカル保存し、接続復帰時に同期
- 完全オフライン対応（PWAキャッシュ）は対象外

### 1.7 アクセシビリティ
- 対応レベル: **基本対応**
- キーボード操作、スクリーンリーダー最低限の対応
- WCAG AA準拠はMVP後

---

## 2. 認証・アカウント（ゲスト＋Googleログイン）

### 2.1 基本方針
- ゲストで開始可能（企業登録/ES編集/タスク管理が可能）
- 必要になったタイミングでGoogleログインに移行（カレンダー連携や有料機能の前提）
- ログイン後は必ずプラン選択画面を表示し、選択確定まで先に進めない
- ログイン促しは機能ごとに1回のみ表示し、以後は控えめな誘導

### 2.2 ゲスト利用
- 初回起動時、ログインなしで利用開始できる（ゲスト状態）
- ゲスト状態の制限:
  - **テンプレ編集は最大1件まで**
  - **スタイル既定保存不可**
  - Googleカレンダー連携は「ログイン促し」を挟む（同意・連携が必要）
- ゲスト制限はFreeの50%を切り上げで適用（テンプレ作成上限は例外で1）
- ゲストデータはサーバーに一時保存（保持期間7日）
- 復元は同一端末のみ自動復元（端末識別）
- カレンダー機能はログイン必須（ゲストは不可）
- ゲストデータは保持期間経過後に自動削除する

### 2.3 Googleログイン
- Googleログインのみ（メール必須のマジックリンクは不採用）
- ゲスト→Google移行時:
  - 同一端末のゲストデータが **自動引継**（確認なし）
  - 7日以内のデータが対象

### 2.4 ゲストデータ警告
- ゲストデータ削除時（7日経過時）: **削除前に警告**を表示
- 警告内容: 「7日間経過するとデータが削除されます」をログイン促進と合わせて表示

### 2.5 利用規約同意
- 同意フロー表示タイミング: **有料機能購入時**
- ゲスト/Free利用では同意画面を表示しない

### 2.6 Googleカレンダー権限
- 最小権限（一覧取得＋空き時間参照＋予定作成/更新/削除）
- 同意画面の心理的ハードル低減を優先

### 2.7 データ同期・削除
- ログインユーザーは端末間でデータが同期される
- アカウント削除は即時に全データ削除（復元不可）

---

## 3. 料金・プラン・制限（確定）

### 3.1 料金
- Standard: 980円/月
- Pro: 2980円/月

### 3.2 Free / 有料差分
**Free:**
- 企業登録 最大5社
- ES添削リライト 1本
- 添削スタイル 3種（バランス/堅め/個性強め）
- テンプレ編集可（上限内）

**Guest（ログイン前）:**
- 企業登録 最大3社
- 月次クレジット 15
- 企業情報取得/更新の無料回数 2回/日
- ES添削リライト 1本
- 添削スタイル 3種（バランス/堅め/個性強め）
- テンプレ作成/編集 上限1

**有料（Standard/Pro共通）:**
- 企業登録 無制限
- リライト 3本
- スタイル 8種（無料3＋短く/熱意強め/結論先出し/具体例強め/端的）
- 設問（H2）ごとの指摘（100〜150字/設問）を付与（全文/セクション/ブロックいずれでも）
- スタイル既定保存（アカウント共通、企業別保存は不採用）

### 3.3 企業RAG（MVPの扱い）
- 対象は公式採用ページ/公式サイトのみ
- 取得ページ上限:
  - Free: 10ページ
  - Standard: 50ページ
  - Pro: 150ページ
- 未取得時:
  - 企業接続評価を出さない
  - 「企業情報を取得」ボタンを表示（取得はクレジット消費対象）
- 抽出結果は根拠URLと信頼度（高/中/低）を必ず表示

### 3.4 プラン運用ルール
- 無料トライアルは無し
- プラン変更は即時反映
- プラン変更日を次回クレジット付与の起点とする
- プラン変更時はクレジット残高を新プランの月次付与量にリセット
- 解約は次回更新日まで有料機能を継続
- 支払い失敗時は即Freeにダウングレード

### 3.5 ダウングレード時のデータ扱い
- Free上限超過データ: **読み取り専用**
- 超過分は閲覧のみ可能
- 編集・新規作成は上限以内になるまでブロック

---

## 4. クレジット仕様（ユーザーが見るルール）

### 4.1 月次付与（加入日起算）
- Free: 30
- Standard: 300
- Pro: 800
- 付与は加入日を起点に毎月行われる（ユーザー向けには「次回付与日」を表示してよい）
- クレジットの繰り越しは無し（毎月リセット）
- プラン変更時は付与起点を変更日にリセットする

### 4.2 企業情報 取得/更新
- 1日無料回数: 3回（アカウント全体合算、JST 0:00で回復）
- ゲストの無料回数は2回/日
- 無料枠外: 成功時に 1クレジット消費
- 失敗時: 消費0（無料回数も減らない）
- 締切が抽出できなかったが他項目が抽出できた場合:
  - 部分成功として0.5クレジット消費
  - 無料回数は消費しない
  - 0.5消費は内部で累積し、2回で1クレジット消費
  - 通知には0.5消費として表示する
  - クレジット残高は整数表示のまま扱う
  - **0.5の可視化**: 残高UIに累積バーを表示し、半分バーが埋まると満タンで1消費
- 部分成功時のUX: **部分成功も価値として伝える**
  - 「締切は取得できませんでしたが、以下の情報を取得しました」と表示

### 4.3 ES添削
- 見積: `ceil(文字数 / 800)` クレジット
- 1回上限: 5
- 上限超過時:
  - 全文一括の実行はできない
  - 分割導線（セクション/ブロック添削）を提示する
- Tips/企業分析のAI利用も同じ消費ルールを適用する

### 4.4 実行履歴（必須）
企業更新・ES添削は、実行結果を必ず通知欄に履歴として残す:
- 成功/失敗
- 消費クレジット（0含む）
- 無料枠使用の有無
- 対象（企業 or ドキュメント）

### 4.5 クレジット不足時
- クレジット不足時は実行不可にして不足量を表示する

---

## 5. 画面一覧（MVP）

1. オンボーディング
2. ダッシュボード（今日の最重要1タスク／通知欄／クレジット残高／無料回数）
3. 企業一覧 / 企業登録
4. 企業詳細（更新/取得、抽出結果、締切承認）
5. カレンダー設定（追加先、freebusy対象）
6. 締切/タスク一覧（応募枠単位）
7. ESエディタ（左右分割/モバイル縦積み、反映、Undo、全文はコピーのみ）
8. ESテンプレ管理／公開ギャラリー
9. 検索結果（グローバル検索）
10. 設定（通知時刻、フィードバックリンク）

---

## 6. オンボーディング

### 6.1 目的
ユーザーの前提情報とガクチカ素材を入力させ、最初のタスク提案・ES作成の起点を整える。

### 6.2 入力項目
- 大学
- 学部
- 志望業界
- 志望職種
- 受けている企業（任意、記録のみで企業登録は後で促す）
- ガクチカ素材（1つ）

### 6.3 完了後の遷移
- ダッシュボードへ遷移し「今日のおすすめタスク」を表示

### 6.4 スキップ
- 初回オンボーディングはスキップ可
- スキップ時も機能制限はしない（必要箇所で入力を促す）
- オンボーディング情報は設定画面からいつでも編集できる

---

## 7. ダッシュボード

### 7.1 目的
- 今日やるべきことを1つに絞って提示し、締切を落とさない。
- 実行結果（更新/添削）と通知を集約する。

### 7.2 表示要素
- 今日の最重要1タスク（ワンタップで開始）
- 通知欄（最大5件＋「他◯件」）
- クレジット残高（残量・次回付与日）
- **今日の無料取得回数**: 「今日の無料取得: 残X回」を常時表示
- 締切が近い警告（3日以内/24時間以内）

### 7.3 ユーザー操作
- 最重要タスクの「開始」→ 対応する画面（ES/企業/ガクチカ/タスク）へ遷移
- 通知のタップ → 詳細表示（成功/失敗・消費量・対象へジャンプ）

---

## 8. 企業登録（Company）

### 8.1 目的
応募企業を起点に、応募枠・締切・提出物・ESを紐づける。

### 8.2 登録フロー
1. 企業名入力
2. 業界選択（事前定義リスト）
3. 登録確定

### 8.3 制限
- Freeは最大5社まで
- ゲストは最大3社まで
- 上限到達時:
  - 明確なエラーメッセージ
  - 有料プラン導線を表示

### 8.4 重複判定
- 企業名は重複登録不可。判定は「同一法人かどうか」を優先
- 近い名前でも別法人なら別企業として登録可能
- 法人判定が曖昧な場合は登録を許可し、企業情報取得時に再判定して統合提案する
- **統合提案のUX**: モーダルで提案
  - 「同一企業の可能性があります」モーダルを表示
  - ユーザーが「統合」または「別企業として維持」を選択

### 8.5 削除時の扱い
- 企業削除時は紐づく応募枠/ES/タスク/締切もすべて削除

### 8.6 並び替え
- 企業/応募枠の並び替え・ピン留めが可能

---

## 9. 企業情報取得/更新（公式情報のみ）

### 9.1 目的
公式採用ページ等から締切候補などを抽出し、進捗管理を自動化する。

### 9.2 入力（ユーザーが決める部分）
- 企業名（登録済み）
- 公式採用ページ候補（3件）から選択
- フォールバック: 採用ページURLを手動で貼り付け（常設）
- 候補URLが見つからない場合は取得をブロックし、手動URL入力で解除する
- 手動URL入力はURLのみでOK。入力URLは公式URLとして保存し、次回更新でも利用する
- 手動で保存する公式URLは複数登録できる

### 9.3 候補提示のルール
- 公式採用ページ候補を3件提示し、ユーザーが選択する
- 低信頼度（LOW）は初期チェックOFF（誤登録防止）
- 取得ページ上限はプランに従う（Free: 10 / Standard: 50 / Pro: 150）
- 上限超過時は自動で間引く
  - 優先度: 採用ページ配下 > 応募/エントリー関連 > その他公式ページ

### 9.4 実行（非同期）
- 「企業情報を取得/更新」ボタン → 処理開始
- 完了後:
  - 通知欄に成功/失敗・消費が残る
  - 抽出結果画面が更新される
- 成功判定は「何か1項目でも抽出できたら成功」とする

### 9.5 抽出結果の表示ルール
- 抽出対象は最小セット（締切/募集区分/提出物/応募方法）
- 各項目に必ず:
  - 根拠URL
  - 信頼度（高/中/低）
- 締切候補は“候補”として提示され、**ユーザー承認**が必要
- 締切が抽出できない場合は他項目を表示しつつ「締切なしは取得できませんでした」と明示する

### 9.6 更新ルール（重要）
- 更新は手動（ユーザーが押す）
- 自動定期更新はしない（MVP）
- 既存データとの差分を提示し、承認された分だけ更新する（削除候補も提示）

---

## 10. 応募枠（Application）

### 10.1 目的
同一企業内で夏/秋/冬インターン、早期、本選考などを区別し、締切とESを整理する。

### 10.2 ユーザー体験（MVP）
- 企業詳細で応募枠を作成・選択できる
- ES作成時に応募枠を選ぶ
- 締切/タスクは応募枠単位でまとまって見える
- 企業情報取得で抽出された締切ごとに応募枠を自動作成する
- 応募枠詳細では最も近い締切のみ表示し、詳細画面で全件を確認する
- 企業 > 応募枠 > 職種 のツリー構造で管理する
- 応募枠の並び順は企業内で締切が近い順
- 応募枠の上限は1企業あたり最大10枠
- 上限到達時はエラーメッセージを出し、有料プラン導線を表示する
- 応募枠を削除した場合は紐づくES/職種/締切/タスクも削除する
- 応募枠の上限は全プラン共通

### 10.3 フェーズ
- エントリー/ES/テスト/面接…のフェーズ概念を持つ
- フェーズはテンプレを用意し、ユーザーが自由に編集できる
  - インターン用テンプレ: ES / WEBテスト / GD / 面接 / インターン参加
  - 早期選考・本選考用テンプレ: ES / WEBテスト / 一次面接 / 二次面接 / 内定
- フェーズ編集はアカウント共通で適用する
- 応募枠作成時にテンプレ（インターン/早期/本選考）を選択する
- 応募枠作成後もテンプレ変更が可能
- テンプレ変更時は既存フェーズを保持し、追加差分のみ提示する
- フェーズは追加/削除/並び替えができる
- フェーズ名の重複は許可する
- MVPでは「自動反映」方針（根拠URLと信頼度表示）を前提とする

### 10.4 複数職種・複数締切
- 職種別/イベント別に分岐し得る前提
- 1つの応募枠に職種/締切を複数ぶら下げる
- 職種は自由入力で複数設定できる
- 職種の並び順は作成日が新しい順
- 職種削除時は紐づくES/締切を応募枠のみの紐づけとして残す
- 職種名を変更した場合は紐づくES/締切の表示名も自動更新する
- 職種の上限は応募枠あたり最大5件
- 職種の上限は全プラン共通
- 職種の上限到達時はエラーメッセージ＋整理導線を表示する
- ゲストも職種上限は最大5件（共通）

---

## 11. 締切（Deadline）承認UX（最重要）

### 11.1 目的
締切の誤抽出を前提に、**締切だけは必ず承認**を挟み、通知・計画に使う。

### 11.2 承認の原則
- 承認対象は「締切のみ」
- 提出物/フェーズは自動反映（ただし根拠URLと信頼度は表示）

### 11.3 承認モーダルの仕様
- 初期状態:
  - すべてチェックON
  - ただし LOW信頼度のみ初期OFF
- ユーザーがチェックで承認する締切を選ぶ
- 0件承認はエラー:
  - 「少なくとも1件は承認してください」
  - 何もしない（追加も削除も行わない）

### 11.4 承認の扱い
- 承認は「カレンダー追加時のチェック＝承認」とみなす（運用一体）
- 計画提案（今日の最重要タスク）は承認済み締切のみを使用する

### 11.5 終日締切ルール
- 終日締切は当日12:00を締切扱い
- 1時間前通知は当日11:00

### 11.6 締切変更検知
- 締切が変更になった場合:
  - 「締切が変更になりました。修正しますか？」を提示
  - 承認で更新（自動更新しない）

### 11.7 提出済み連動
- ユーザーが締切を「提出済み」にする
- 提出済みON:
  - 紐づく未完了タスクを一括完了
- 提出済み解除:
  - “この操作で完了にしたタスク”だけ一括で未完了に戻す

### 11.9 締切削除時の扱い
- 締切削除時は紐づく未完了タスクを自動削除する

### 11.8 手動追加・編集
- ユーザーが締切を手動で追加/編集できる
- 手動締切は自動で承認済み扱い
- 手動締切は日付＋時間を入力可能。時間未入力の場合は当日12:00扱い
- 手動締切も企業情報更新の差分対象に含める
- 締切の種別は事前定義から選択する
- 事前定義種別: ES提出 / WEBテスト / 適性検査 / 一次面接 / 二次面接 / 説明会 / インターン参加 / その他
- 手動締切にメモ欄と参考URL欄を用意する
- 締切は応募枠に加えて職種にも紐づける

---

## 12. 通知（Notifications）

### 12.1 目的
- 提出忘れ防止
- 更新/添削/消費の可視化（必須ログ）

### 12.2 通知の種類
- 締切リマインド（前日、1時間前がデフォルト）
- 締切が近い（3日以内/24時間以内）
- 企業更新結果（成功/失敗・消費・無料枠使用）
- ES添削結果（成功/失敗・消費）
- ユーザー追加タスクの締切も通常の締切通知対象に含める
- 締切リマインドは承認済み締切のみ通知する
- 締切リマインドのタイミングはユーザーが自由に追加/削除/変更できる

### 12.3 配信と表示
- 通知チャネルはアプリ内のみ
- **日次通知時刻**: 選択式（7:00 / 9:00 / 12:00 / 18:00 から選択可能）
  - デフォルトは9:00（JST）
- 通知一覧は最大5件＋「他◯件」
- 通知をタップすると対象画面へ遷移できる（企業/ES/締切/タスク）
- 未読/既読を持ち、詳細画面を開いたタイミングで既読化
- 「すべて既読」ボタンを用意する
- **通知削除**: 個別削除＋「すべて削除」の両方を提供
- 通知タイプごとのON/OFF設定を用意
- 通知は90日で自動削除
- 日次通知は「最重要1タスク＋近い締切」を含める

---

## 13. タスク・進捗管理

### 13.1 タスクの目的
締切に向けた行動を具体化し、今日やることを迷わせない。

### 13.2 タスク作成
- ユーザーが任意タスクを追加できる（締切設定可）
- 追加タスクは企業/応募枠に紐づけ可能
- 追加タスクも「最重要1タスク」の推薦対象に含める
- 締切承認時に標準タスクを自動作成（ES作成/提出物準備/提出）
- 締切承認時に提出物テンプレの項目も標準タスクとして自動生成する
- 標準タスクは個別期限を持たず、締切のみで管理する
- 自動生成タスクは編集可能。編集後は手動タスク扱いとして自動更新しない

### 13.3 今日の最重要1タスク（推薦ロジック：確定）
- 承認済み締切のうち、`due_at <= now + 72h` が1件でもある → **締切優先（DEADLINE）**
- それ以外 → **深掘り優先（DEEP_DIVE）**
- **72h閾値は固定**（カスタマイズ不可）

### 13.4 締切優先（DEADLINE）の挙動
- 応募枠の選定:
  - `score = open_tasks_count / max(1, hours_to(nearest_due))`
  - score最大の応募枠を選ぶ（同点は締切が近い方）
- その応募枠のOPENタスクを1件提示
  - 同点は作成が古い方

### 13.5 深掘り優先（DEEP_DIVE）の挙動
- 優先順位:
  - `ES_DRAFT` → `GAKUCHIKA` → `OTHER`
- 同順位なら:
  - 企業登録が早い企業に紐づく応募枠を優先
  - その中でタスク作成が古いものを優先

### 13.6 完了状態と扱い
- DONEタスクは推薦対象外
- 提出済み操作による一括完了/巻き戻しは締切仕様に従う
- タスクの自動完了は「提出済み」操作時のみ行う

### 13.8 タスク一覧の並び順
- 締切が近い順

### 13.7 タスク種別
- 事前定義の種別を用意し、設定から新しい種別を追加できる
  - 事前定義例: ES / Webテスト / 自分史 / ガクチカ / 動画・録画 / その他
  - 追加した種別はアカウント共通
  - 種別削除時は該当タスクを「その他」に自動変換

---

## 14. カレンダー連携（Google / アプリ内）

### 14.1 初回設定（必須）
- カレンダー機能はログイン必須
- 初回に「Googleカレンダー連携」か「アプリ内カレンダー新規作成」か選択
- 2回目以降は初回設定の追加先に自動追加
- 追加先は設定からいつでも切替可能
- 追加先は「Google」か「アプリ内」のどちらか1つのみ（同時併用なし）
- 追加先を変更しても既存のウカルン予定は移行せず、以後の予定のみ新しい追加先に入れる

### 14.2 Googleカレンダー設定
- Googleカレンダー一覧から追加先を選べる（仕事用/個人用など）
- 1クリックで「就活用（ウカルン）」カレンダーを新規作成できる
  - description: 「ウカルンが作成した締切・作業ブロック管理」
- 初回Google連携後は必ず「追加先カレンダー選択画面」を表示

### 14.3 freebusy（空き時間算出）
- 対象: `freebusy_calendar_ids` のみ
- **全カレンダー一括は採用しない**
- ユーザーは「空き時間算出対象カレンダー」を明示的に選ぶ

### 14.4 提案→承認→追加（必須フロー）
- カレンダー連携は「提案のみ」
- アプリ上に「承認する」ボタン
- 承認→最終確認ポップアップ→「はい」で登録

#### 例外
- 0件承認（チェックなし）はエラー。何もしない。

### 14.5 イベント識別（事故防止）
- タイトル接頭辞:
  - `[ウカルン][締切] ...`
  - `[ウカルン][作業] ... #1`
- `extendedProperties.private` に識別子を入れる
- 削除/置換はウカルン作成分のみ（ユーザー予定は触らない）
- 作業ブロックのタイトル編集時も接頭辞は保持する（編集不可）

### 14.6 置換ルール
- 置換モード(B):
  - 削除OFFを許可しない（削除必須）
  - 追加0件ならエラー。削除もしない
- 検索範囲（置換用）:
  - 過去30日＋未来1年

### 14.7 作業ブロック
- 30〜90分を基本
- 上限は120分
- 短時間ブロックも登録可能
- 連番付与（#1/#2）
- 作業ブロックのタイトルは初期自動付与し、ユーザーが編集できる
- 締切承認後に作業ブロック候補を自動提案し、ユーザーが承認/拒否を選択する
- 拒否された場合は自動再提案しない（手動トリガーのみ）
- 提案対象期間は締切までの全期間
- 提案本数は締切までに必要と想定される最小本数に絞る
- 作業ブロックの希望時間帯（朝/昼/夜など）をユーザーが設定できる
- 作業ブロック必要本数はタスク数・種類から算出する
- 作業ブロックは1日あたり上限を設ける
- 上限は1日3本まで
- 同日に複数の作業ブロックを提案してよい

### 14.8 連動ルール
- 締切/応募枠を削除した場合、ウカルン作成予定は自動削除
- 締切変更が承認された場合は、ウカルン作成の締切予定を自動更新する
- Googleカレンダー側でウカルン予定を手動編集/削除した場合は、次回同期でウカルン側にも反映する
  - **外部削除の同期**: 次回同期時にウカルン側も削除済みとして扱う（再作成提案は行わない）

### 14.9 同期エラー処理
- リトライ戦略: **3回まで自動**
- バックグラウンドで3回まで自動リトライ
- それでも失敗したら通知でエラーを伝える

---

## 15. ESエディタ（Notion風ドキュメント）

### 15.1 画面構成
- 左右分割
  - 左: ES本文（Notion風）
  - 右: 添削AIチャット
- **モバイル対応**: 縦積み
  - モバイルでは本文を上、AIチャットを下に配置
  - スクロールで両方を参照可能

### 15.2 ドキュメント種別
- 固定enum: ES / Tips / 企業分析
- ESのみ応募枠に紐づけ
- Tips/企業分析は企業に任意紐づけ可（応募枠には紐づけない）
- ESは応募枠ごとに複数作成可能
- ESは応募枠に加えて職種にも紐づけできる

### 15.3 新規作成導線
- 種別選択 →（ESなら）企業→応募枠選択 → 作成
- 応募枠が無ければその場で新規作成可能
- ESは空白で作成し、必要ならテンプレを挿入する
- テンプレ挿入時は選択画面を表示する
- タイトルは「企業名＋応募枠＋職種＋作成日」で自動付与し、後から編集可能

### 15.4 ES構造（H2必須）
- ESはH2（設問見出し）必須
- H2削除＝該当セクション（本文含む）丸ごと削除
- H2タイトルは自由入力
- H2編集モーダルで設問メタを入力:
  - title / question_text / target_chars
- 右ペインAIへ自動供給される
- Tips/企業分析はH2任意

### 15.5 ブロック種別（MVP最小）
- H2（設問）
- 段落
- 箇条書き（番号/点）

### 15.6 文字数カウント
- 設問（セクション）単位で「現在X / Y字」
- 除外:
  - 箇条書き記号・番号
  - 空白
  - 改行

### 15.7 保存・履歴・削除・並び替え
- 保存は手動
- 画面離脱時に未保存警告を出す
- H2（設問）未設定や必須メタ不足時は保存不可
- 編集履歴は直近5版を保持し、手動保存ごとに版を作成
- 履歴からの復元はドキュメント全体の巻き戻し
  - **復元時の警告**: 確認モーダルで「現在の内容が失われます。復元しますか？」と確認
  - 復元前に現在状態を履歴に保存はしない
- 履歴画面への導線はES編集画面のメニューから開く
- 同時編集は最後の保存を優先（last write wins）
  - **競合時の挙動**: 警告なし。競合検知・警告は行わない
- ES削除はゴミ箱へ移動し、30日で自動削除（復元可）
- ES一覧は並び替え/ピン留め可能。企業/応募枠も並び替え可能
- Tips/企業分析は簡易管理（履歴/ゴミ箱/並び替えの対象外）

---

## 16. AI添削（出力・分岐・反映UX）

### 16.1 添削の種類（ユーザー視点）
- 全文添削（提供するが反映不可＝コピーのみ）
- セクション（H2）添削
- 連続ブロック添削（非連続不可）
- **並列添削**: 同一ESでの複数添削同時実行可能
  - セクションAとセクションBを同時に添削可能
  - クレジットは各添削で個別消費
- **添削中の編集**: 編集ロック
  - 添削対象セクションは添削完了まで編集をロック
  - 他のセクションは編集可能
- AIチャットはESごとに複数スレッドを作成可能。新規スレッド作成は明示操作とする
- 新規スレッド開始時にガクチカ素材を選択し、そのスレッド内では自動参照する
- Tips/企業分析にもAIスレッドを付与する
- **対応言語**: 日本語・英語両方のESを添削可能
  - 言語自動判定は行わない（入力テキストから判断）

### 16.2 出力（共通）
- スコア（5軸）:
  - 論理/具体性/熱意/企業接続/読みやすさ
- 改善優先順位Top3
- リライト（Free/有料差分）
- 添削の実行前にクレジット見積の確認は挟まない
- **AIコンテキスト範囲**: 対象範囲のみ
  - 添削対象のセクション/ブロックのみをAIに渡す
  - 他設問やガクチカ素材は含めない

### 16.3 リライト（Free/有料）
**Free**
- 1本
- スタイル3種（バランス/堅め/個性強め）

**有料**
- 3本
- 既定はバランス/堅め/個性強め（指定が無ければ固定）
- スタイル8種（無料3＋短く/熱意強め/結論先出し/具体例強め/端的）

### 16.4 設問別指摘（有料）
- 設問（H2）ごとに修正点指摘（各100〜150字）
- 全文/セクション/ブロック添削のいずれでも付与

### 16.5 企業接続評価の条件
- 企業RAG未取得なら企業接続評価を出さない
- 「企業情報を取得」ボタンを提示（クレジット消費対象）

### 16.6 反映UX（安全仕様）
- 反映単位:
  - セクション（H2）反映
  - 連続ブロック選択反映
- 連続ブロックのみ（Shift範囲選択）
- 見出し（H2）が選択に含まれる場合:
  - 見出しは置換対象から除外
- 追記（挿入）:
  - 選択範囲の最後の本文ブロック直後
- 反映前:
  - 確認モーダル必須
- 反映後:
  - Undo提供
- 反映した事実はチャットにイベントとして残す（スタイル名は表示しない）

### 16.7 全文添削の扱い
- 全文添削はMVPで提供する
- 反映不可（コピーのみ）

### 16.8 添削結果の保存・ピン留め
- ドキュメント本体に添削履歴は保存しない（チャット履歴に集約）
- 添削結果カードはESドキュメント単位で最大3件ピン留め可能
- ピン留めからタスク作成ボタンは入れない（MVPはES編集に集中）
- 添削履歴の保存上限:
  - Free: 直近20件
  - Standard: 直近200件
  - Pro: 無制限
- 上限超過時は最古の履歴から自動削除する

### 16.9 ES初期テンプレ
- 初期テンプレは5種類を用意し、テンプレ一覧から選択できる
  - インターン①（夏想定）
    - 「インターンの応募理由を教えてください。」
    - 「学生時代に力を入れたことを教えてください。」
    - 「チームで取り組んだ経験を教えてください。」
  - インターン②（秋想定）
    - 「当社インターンを志望する理由を教えてください。」
    - 「あなたの強みを教えてください。」
    - 「課題を解決した経験を教えてください。」
  - インターン③（冬想定）
    - 「当社インターンを選んだ理由を教えてください。」
    - 「志望職種に必要な力は何か教えてください。」
    - 「インターンで挑戦したいことを教えてください。」
  - 早期選考
    - 「当社を志望する理由を教えてください。」
    - 「入社後にやりたいことを教えてください。」
    - 「会社選びの軸を教えてください。」
  - 本選考
    - 「学生時代に最も力を入れたことを教えてください。」
    - 「自己PRを教えてください。」
    - 「当社・志望職種を選ぶ理由を教えてください。」
- テンプレは「テンプレートを追加・編集」画面から編集できる（最大10設問）
  - ゲストも編集可（作成/編集は最大1件）
- 初期テンプレは上書き編集できる
- テンプレ作成上限:
  - Free: 3
  - Standard: 10
  - Pro: 15
  - ゲスト: 1
- テンプレの設問メタの目標文字数は全設問400字を初期値とする
- ES作成後に質問（H2）を追加できる
- テンプレ変更は新規作成にのみ適用（既存ESには自動反映しない）
- 設問ごとの必須フラグは持たない（ガイド）
- テンプレ編集の履歴は残さない（上書きのみ）
- テンプレは他ユーザーと共有できる
- 共有リンクからテンプレをコピーして自分のテンプレに追加できる
- 共有テンプレは複製扱いで、コピー後は自由編集（共有元に影響しない）
- 共有テンプレは公開ギャラリーに掲載できる
- 公開ギャラリーは有料プランのみ閲覧・検索できる
- ただし「人気」タブはFreeでも閲覧できる（コピーは有料のみ）
- 公開テンプレのコピーは有料プランのみ可能
- 共有リンクの閲覧も有料プラン限定
- 共有リンクの閲覧時はログイン必須（有料プラン判定を行う）
- 公開テンプレのいいねはFreeでも可能
- 公開テンプレのお気に入りは有料ユーザーのみ
- お気に入りは最大30件まで
- いいねは取り消し可能
- お気に入りは解除可能
- お気に入りは1ユーザー1テンプレにつき1回（トグル式）
- 共有リンクの閲覧数/コピー数は投稿者が確認できる
- 投稿者はコピーしたユーザー一覧は見られない（集計のみ）
- いいねの通知は投稿者に送らない
- コピーの通知は投稿者に送らない
- 閲覧の通知は投稿者に送らない
- 共有リンクには有効期限を設ける（30日）
- 共有リンクは同じテンプレで再発行できる
- 再発行時は以前のリンクを無効化し、新しいリンクのみ有効
- テンプレの共有/コピーはクレジット消費なし
- 公開ギャラリーへの投稿は有料プランのみ可能
- 公開ギャラリーへの投稿は即時公開する
- 公開ギャラリーの評価は「いいね/お気に入り」のみ
- 共有リンクは手動で無効化できない（期限切れ/再発行/ギャラリー削除で無効化される）
- 公開ギャラリーのテンプレは投稿者が削除できる
- 公開ギャラリーはランキング表示（週/月/年のTop）も用意する
- ランキング表示件数はTop10のみ
- ランキング指標は「いいね数＋コピー数」の複合指標
- ランキングは週/月/年の区切りで更新（週=月曜0:00、月=1日0:00、年=1/1 0:00）
- 人気順は全期間の累計いいね/コピー数を指標にする
- 人気タブは1日1回（JST 0:00）更新
- 人気タブはTop50まで表示する
- 共有テンプレの著者表示は投稿時に選択できる（作者名表示/匿名表示）
- 公開ギャラリーはキーワード検索＋タグ/業界フィルタを用意する
- タグ/業界は複数選択でき、AND/ORを選択可能
- フィルタのデフォルト結合はOR
- 検索結果は関連度順（キーワード一致優先）で表示する
- 公開ギャラリーに通報機能は用意しない
- 運営による定期的な巡回チェックを行う
- **スパム対策**: 投稿制限を追加
  - 1日あたりの投稿数上限を設ける（例: 5件/日）
- 公開済みテンプレの編集は自動反映しない。投稿者が「変更を公開版に反映」操作で反映する
- 公開ギャラリーから削除したテンプレは共有リンクも無効になる
- 公開テンプレを削除しても、既にコピーしたユーザーのテンプレは残る
- コピーしたテンプレにコピー元の情報は表示しない
- 公開テンプレの更新は既にコピーしたユーザーへ通知しない
- 公開テンプレのタグは投稿者が自由に追加できる
- 公開ギャラリーのおすすめは「いいね/コピー数」で自動決定する
- 公開ギャラリーは新着/人気/ランキングのタブを用意する
- 新着は最終更新日時が新しい順
- 公開ギャラリーの初期表示は「人気」タブ
- 公開テンプレの詳細は質問一覧＋想定用途/業界などの説明文を表示する
- 公開テンプレ投稿時の必須項目はタイトルのみ（説明/タグは任意）
- 公開テンプレは日本語/英語に対応し、投稿時に選択する
- 公開テンプレの利用範囲は「個人利用のみ」
- 公開テンプレのコピー上限は設けない
- 公開テンプレはコピー数を表示する
- 公開テンプレはいいね数を表示する
- いいねに上限は設けない
- いいねは1ユーザー1テンプレにつき1回（トグル式）
- いいねしたテンプレ一覧はユーザー自身が確認できる
- 公開ギャラリーにフォロー機能は用意しない
- お気に入りはギャラリー内でのみ保存する
- お気に入り一覧の表示は有料ユーザーのみ
- お気に入り一覧は追加順（新しい順）で表示する

### 16.10 AIスレッド管理
- 1ESあたりのスレッド上限は10件
- 上限超過時は新規作成をブロックし、削除/アーカイブを促す
- アーカイブ/削除したスレッドは復元可能
- AIチャット履歴はESごとに直近100件まで保存する
- Tips/企業分析もAIチャット履歴は各ドキュメント直近100件まで保存する
- AIスレッドはユーザーがスレッド単位で削除できる
- **ES添削スレッドの中断・再開**: 再開可能
  - ガクチカ深掘り同様、ES添削スレッドも中断・再開可能

---

## 17. ガクチカ深掘りBot（MVP）

### 17.1 目的
質問を通じてガクチカの材料を深掘りし、ES作成・添削に活用できる状態にする。

### 17.2 MVPとして確定していること
- 機能として搭載する（深掘り対話が可能）
- 「深掘り優先」モードではGAKUCHIKA系タスクとして推薦対象に入る
- 対話回数は目安8問（内容により早終了/追加あり）
- 保存形式はQ&Aの会話ログ
- 中断/再開が可能
- 同じ素材に対して再実行できる
  - **再実行時のデータ扱い**: 履歴として残す
  - 前回の深掘り結果は履歴として保持
  - 新しい深掘りは別セッションとして追加
- クレジット消費は5問回答ごとに1（5問未満で終了した場合は消費なし）

### 17.3 ガクチカ素材の管理
- 素材は複数登録可能
- 上限は Free=3 / Standard=10 / Pro=20 / ゲスト=2
- 素材は汎用として登録し、企業/応募枠に任意で紐づけできる（複数企業選択可）
- AIスレッド開始時に参照素材を選択し、そのスレッド内で自動参照する
- 素材は編集/削除できる
- ガクチカ素材は並び替え可能

---

## 18. 提出物テンプレ（確定）

### 18.1 標準項目
- 履歴書（PDF）: 必須、削除不可
- ES（テキスト/フォーム貼付）: 必須、削除不可
- 証明写真: 任意
- 成績証明書: 任意
- 在学証明書: 任意
- ポートフォリオURL: 任意
- その他: 任意

### 18.2 編集可否
- 履歴書/ESは削除不可
- それ以外は編集・削除可能

---

## 19. 典型ユーザーフロー（機能横断）

### フローA：最短セット（企業→締切→通知→最重要タスク）
1. 企業登録
2. 企業情報を取得/更新（候補3件選択 or URL貼付）
3. 締切候補が出る → 承認モーダルで承認
4. 通知が来る（前日/1時間前、日次9:00）
5. ダッシュボードで「最重要1タスク」を実行

### フローB：ES改善（作成→添削→部分反映）
1. ES新規作成（企業→応募枠）
2. H2設問を入力し、目標字数を設定
3. 添削（全文/セクション/ブロック）
4. セクション/連続ブロックで反映（確認→反映→Undo）
5. 良い結果を最大3件ピン留め

### フローC：カレンダー（提案→承認→追加、置換）
1. Google連携 or アプリ内カレンダー選択
2. 追加先カレンダー選択（または就活用（ウカルン）を1クリック作成）
3. freebusy対象カレンダーを選択
4. 予定候補を提案 → チェックで承認 → 最終確認 → 追加
5. 置換モード(B)で整合（ウカルン作成分のみ、0件はエラー）

---

## 20. 受入観点（ユーザー目線のDone定義）

### 20.1 クレジット/無料枠
- 企業更新は1日3回まで無料（成功時のみカウント）
- 無料回数が尽きた後は、成功時のみ1クレジット消費
- ES添削は文字数見積で消費、上限5を超えると全文実行不可（分割導線）
- 更新/添削の結果が必ず通知欄に残る

### 20.2 締切/提出済み
- 締切だけ承認必須（LOWは初期OFF）
- 提出済みONで紐づく未完了タスクが一括完了
- 提出済み解除は巻き戻し範囲が限定される

### 20.3 推薦
- 72h以内に承認締切があればDEADLINE、なければDEEP_DIVE
- DEEP_DIVEは type 優先（ES→ガクチカ→その他）

### 20.4 カレンダー
- freebusyは選択カレンダーのみ参照
- ウカルン作成イベントのみ変更対象（事故防止）

### 20.5 ESエディタ
- 全文添削は反映不可（コピーのみ）
- ピン留めは最大3件
- 反映は確認モーダル＋Undo必須

---

## 21. 用語集（ユーザー体験で使う言葉）
- H2：ES内の設問セクション見出し（ESでは必須構造）
- 応募枠：同一企業内の夏/秋/冬インターン、早期、本選考などの区分
- 締切：ES提出やイベント申込などの期限。承認対象
- 作業ブロック：締切に向けて確保する作業時間のカレンダー予定（連番付与）
- RAG：企業の公式ページ等を取得・参照して企業接続評価に使う仕組み
- Top3：改善優先度の上位3点
- 置換モード：ウカルン作成予定を削除して新候補を追加し整合性を保つ運用

---

## 22. 検索機能（MVP）

### 22.1 提供する検索機能
- **全文検索**: 企業/ES/締切を横断する全文検索を提供
- 企業名、ES本文、締切タイトルなどを検索可能

### 22.2 検索UI
- グローバル検索バーをヘッダーに配置
- 検索結果は種別（企業/ES/締切）ごとにグループ化して表示

---

## 23. データエクスポート（MVP）

### 23.1 提供する機能
- **ESのPDF出力**: ESドキュメントをPDF形式でエクスポート
- **締切一覧のCSV出力**: 締切一覧をCSV形式でエクスポート

### 23.2 エクスポート導線
- ESエディタのメニューからPDF出力
- 締切一覧画面からCSV出力

---

## 24. APIセキュリティ・レートリミット

### 24.1 レートリミット
- 実装レベル: **厳格な制御**
- 機能別の細かいレート制限を設ける:
  - ES添削: 10回/時間
  - 企業情報取得: 5回/分
  - その他: 適切な制限値を設定

### 24.2 不正利用対策
- クレジット/無料回数に加えて、技術的なレートリミットを実装
- 異常なリクエストパターンを検知した場合は一時的にブロック

---

## 25. 将来拡張

### 25.1 プッシュ通知
- 将来計画: **LINE通知検討**
- PWAプッシュよりLINE連携で締切リマインドを送る方向

### 25.2 フィードバック機能
- MVPでの対応: **外部リンク**
- Googleフォームまたはメールリンクで対応
- アプリ内フォームはMVP後

### 25.3 企業RAG更新戦略
- 更新時の挙動: **差分追加**
- 既存RAGを残し、新しいURLの分のみ追加
- 完全置換はしない
