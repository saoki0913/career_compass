# ES添削機能（実装フロー & プロンプト仕様）

本書は現行実装に基づく **ES添削機能** のフローとプロンプト仕様をまとめたものです。
参照実装: `backend/app/routers/es_review.py`, `backend/app/prompts/es_templates.py`, `backend/app/utils/llm.py`, `src/app/api/documents/[id]/review/route.ts`

---

## 1. 概要

- **目的**: ES（エントリーシート）文章の品質評価・改善提案・リライト
- **評価軸**: 論理 / 具体性 / 熱意 / 企業接続（RAG有り時）/ 読みやすさ
- **モード**:
  - `review_mode = "full"`（全文添削）
  - `review_mode = "section"`（設問単位）
  - `template_request` 指定時は**テンプレ添削**（設問単位のみ）
- **LLM**: Claude Sonnet（feature=`es_review`）

---

## 2. エンドツーエンドの流れ

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   Frontend   │────▶│  Next.js API │────▶│   FastAPI    │────▶│   Claude LLM │
│              │     │              │     │              │     │   (Sonnet)   │
└──────────────┘     └──────────────┘     └──────────────┘     └──────────────┘
      │                     │                    │                     │
      │ 1. POST /api/       │ 2. 認証/クレジット  │ 3. RAGコンテキスト   │ 4. JSON出力
      │    documents/:id/   │    確認 + 中継      │    取得 + プロンプト │
      │    review           │                    │    構築              │
      ▼                     ▼                    ▼                     ▼
```

1. **フロント → Next.js API**
   - `POST /api/documents/:id/review`
   - 認証 / クレジット確認 / テンプレ用の企業情報取得

2. **Next.js API → FastAPI**
   - `POST /api/es/review`
   - `review_mode` / `section_title` / `template_request` を中継

3. **RAG コンテキスト取得（任意）**
   - `company_id` が指定され、RAGが存在する場合のみ
   - ハイブリッド検索（Dense強化 + BM25）
   - 最大 3000 文字（ESコンテンツ長に応じて動的調整）

4. **LLM 呼び出し**
   - feature=`es_review` → Claude Sonnet
   - JSON形式で出力

5. **レスポンス整形**
   - JSONパースできない場合は 503
   - テンプレは最大3回リトライ

6. **Next.js API 後処理**
   - 成功時のみクレジット消費
   - AI thread に履歴保存
   - 返却

---

## 3. Next.js API（認証・クレジット・中継）

**ファイル:** `src/app/api/documents/[id]/review/route.ts`

### 主な役割
- 認証 / ゲスト制限
- クレジット計算: `Math.min(5, Math.ceil(文字数 / 800))`
- テンプレ添削時、企業名・業種をDBから取得
- FastAPIへ中継
- 開発環境ではモック結果にフォールバック

### クレジット消費テーブル

| 文字数 | クレジット |
|-------|-----------|
| 1〜800 | 1 |
| 801〜1600 | 2 |
| 1601〜2400 | 3 |
| 2401〜3200 | 4 |
| 3201〜 | 5（上限） |

---

## 4. FastAPI ES Review Router

**ファイル:** `backend/app/routers/es_review.py`

### 入力パラメータ（主要）
```json
{
  "content": "ES本文",
  "review_mode": "full" | "section",
  "style": "バランス",
  "is_paid": false,
  "has_company_rag": false,
  "company_id": "...",
  "rewrite_count": 1,
  "sections": ["設問1", "設問2"],
  "section_data": [{"title": "設問1", "content": "...", "char_limit": 300}],
  "section_title": "設問タイトル",
  "section_char_limit": 300,
  "template_request": {
    "template_type": "company_motivation",
    "company_name": "○○株式会社",
    "industry": "IT",
    "question": "志望理由を述べてください",
    "answer": "...",
    "char_min": 300,
    "char_max": 400,
    "intern_name": "夏季インターン",
    "role_name": "エンジニア職"
  }
}
```

### スタイルオプション
- **Free**: バランス、堅め、個性強め（3種類）
- **Paid**: 上記 + 短く、熱意強め、結論先出し、具体例強め、端的（計8種類）

### 出力（共通）
```json
{
  "scores": {"logic": 3, "specificity": 3, "passion": 3, "readability": 3, "company_connection": 3},
  "top3": [{"category": "具体性", "issue": "...", "suggestion": "...", "difficulty": "easy"}],
  "rewrites": ["..."]
}
```

---

## 5. RAG コンテキスト取得（ES添削用）

**使用関数:**
- `get_enhanced_context_for_review`（全文/通常）
- `get_enhanced_context_for_review_with_sources`（テンプレ添削）

**挙動:**
- ハイブリッド検索（Dense強化 + BM25）で最大15件
- ESコンテンツ長に応じた動的コンテキスト長（1500〜3000トークン）
- 出力に **採用/IR/事業紹介/構造化** の種別ラベルを付与
- テンプレ添削時は `sources` を S1〜S5 で付与
- Query Expansion + LLM Rerank で関連度を改善

### 動的コンテキスト長

| ESコンテンツ長 | コンテキスト上限 |
|--------------|----------------|
| < 500文字 | 1500トークン |
| 500〜1000文字 | 2500トークン |
| >= 1000文字 | 3000トークン |

---

## 6. フロントエンド実装

### 6.1 useESReviewフック

**ファイル:** `src/hooks/useESReview.ts`

```typescript
interface UseESReviewReturn {
  review: ReviewResult | null;
  isLoading: boolean;
  error: string | null;
  creditCost: number | null;
  reviewMode: "full" | "section";
  currentSection: CurrentSectionInfo | null;

  requestReview(params: ReviewParams): Promise<boolean>;
  requestSectionReview(params: SectionReviewParams): Promise<boolean>;
  clearReview(): void;
}
```

**リクエストパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| content | string | ES/セクション本文 |
| style | string | リライトスタイル |
| reviewMode | "full" \| "section" | 添削モード |
| sectionTitle | string? | セクションタイトル（セクションモード時） |
| sectionCharLimit | number? | 文字数制限（セクションモード時） |
| templateType | string? | テンプレートタイプ |
| internName | string? | インターン名（テンプレ用） |
| roleName | string? | 職種名（テンプレ用） |
| hasCompanyRag | boolean | 企業RAGの有無 |
| companyId | string? | 企業ID |
| sections | string[]? | セクションタイトル一覧（有料プラン用） |
| sectionData | SectionData[]? | セクションデータ（有料プラン用） |

### 6.2 コンポーネント階層

```
ReviewPanel (メインコンテナ)
├── ScoreDisplay (5軸スコア + 企業RAGステータス)
├── ImprovementList (top3改善点・カテゴリバッジ付き)
├── TemplateReview (3パターン + pros/cons) [テンプレモード時]
│   ├── Variants (3パターンの改善案)
│   └── KeywordSources (RAG出典表示)
├── RewriteDisplay (複数リライト選択肢)
├── SectionFeedbacks (設問別フィードバック) [有料プランのみ]
└── ActionButtons (新規添削、全文モードへ戻る)
```

### 6.3 ImprovementList カテゴリ色分け

| カテゴリ | 日本語 | カラー |
|---------|--------|--------|
| logic | 論理 | Blue |
| specificity | 具体性 | Emerald |
| passion | 熱意 | Orange |
| company_connection | 企業接続 | Purple |
| readability | 読みやすさ | Cyan |
| other | その他 | Gray |

### 6.4 設問添削の文字数制限

**プリセット値:**
- 200文字
- 300文字
- 400文字
- 500文字
- 600文字
- 800文字
- 1000文字
- カスタム入力可能

**文字数ステータス表示:**

| 状態 | 条件 | カラー |
|------|------|--------|
| safe | < 70% | Green |
| warning | 70〜89% | Yellow |
| alert | 90〜99% | Orange |
| error | >= 100% | Red |

---

## 7. テンプレート定義

**ファイル:** `backend/app/prompts/es_templates.py`

### テンプレート一覧

| テンプレートID | ラベル | キーワード数 | 強化ポイント | 企業RAG必須 | 追加フィールド |
|---------------|--------|-------------|-------------|------------|---------------|
| `basic` | 汎用ES添削 | 2 | No | Yes | - |
| `company_motivation` | 企業志望理由 | 2 | No | Yes | - |
| `intern_reason` | インターン志望理由 | 0 | Yes | Yes | `intern_name` |
| `intern_goals` | インターンでやりたいこと | 2 | No | Yes | `intern_name` |
| `gakuchika` | ガクチカ | 0 | Yes | No | - |
| `post_join_goals` | 入社後やりたいこと | 2 | No | Yes | - |
| `role_course_reason` | 職種・コース選択理由 | 0 | No | Yes | `role_name` |
| `work_values` | 働く価値観 | 0 | Yes | No | - |

---

## 7.5 プロンプトアーキテクチャと設計思想

本セクションでは、ES添削プロンプトの設計思想と技術的な構成について解説する。

### 7.5.1 設計思想

ES添削プロンプトは以下の設計原則に基づいている:

1. **階層的構成**: ロール → 条件 → 評価観点 → 出力形式の順で構造化
2. **分離原則**: システムプロンプト（静的な指示）とユーザープロンプト（動的なコンテンツ）を分離
3. **テンプレート駆動**: 設問タイプごとに専用の評価観点・チェックリストを適用
4. **RAG統合**: 企業固有の情報を動的に注入し、添削精度を向上

### 7.5.2 プロンプト構成フロー

`build_template_prompt` 関数（es_templates.py:400-617）がプロンプトを組み立てる:

```
┌─────────────────────────────────────────────────────────────┐
│                    入力パラメータ                            │
│  template_type, company_name, industry, question, answer,   │
│  char_min, char_max, rag_sources, rag_context, keyword_count│
│  has_rag, intern_name, role_name                            │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│              テンプレート定義取得                            │
│  TEMPLATE_DEFS[template_type] → keyword_count, 等           │
│  TEMPLATE_PROMPTS[template_type] → role, aspects, checklist │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│              System Prompt 組み立て                         │
│  1. ロール定義（「あなたは○○のプロフェッショナルである」）   │
│  2. 条件セクション（文字数、業界、企業、設問）              │
│  3. 文字数配分ガイド（15/70/15ルール）                      │
│  4. 添削の観点（テンプレート固有の評価基準）                │
│  5. 出力要件（3パターン、キーワード、文字数厳守）           │
│  6. チェックリスト                                          │
│  7. JSON出力形式（スキーマ指定）                            │
│  8. スコア基準（5軸評価の説明）                             │
│  9. 3パターン差別化ガイド                                   │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────────┐
│              User Prompt 組み立て                           │
│  1. 添削前の回答                                            │
│  2. 企業RAG資料（has_rag=true時のみ）                       │
│  3. 出典一覧                                                │
│  4. 出力指示                                                │
└──────────────────────────┬──────────────────────────────────┘
                           ▼
                 return (system_prompt, user_prompt)
```

### 7.5.3 文字数配分ガイド

`get_character_budget` 関数（es_templates.py:353-397）が文字数配分を計算:

```python
# 15/70/15 ルール
intro_budget = int(target * 0.15)   # 導入（結論/主張）: 15%
body_budget = int(target * 0.70)    # 本論（具体的経験・根拠）: 70%
conclusion_budget = int(target * 0.15)  # 結論（まとめ・展望）: 15%
```

**計算例（400字指定の場合）:**
- 導入: 60字
- 本論: 280字
- 結論: 60字

このガイドにより、LLMが事前に文字数配分を計画してから執筆できる。

### 7.5.4 System Prompt の構成要素

| 順序 | 要素 | 役割 | ソース行 |
|-----|------|------|----------|
| 1 | ロール定義 | LLMにES添削の専門家としての役割を付与 | 533-534 |
| 2 | RAG-lessガイド | 企業情報がない場合の特別指示 | 520-528 |
| 3 | 条件セクション | 文字数、業界、企業、設問の指定 | 469-480 |
| 4 | 文字数配分ガイド | 構造的な文字数配分の提示 | 530-531 |
| 5 | 添削の観点 | テンプレート固有の評価基準（5〜15項目） | 539 |
| 6 | 出力要件 | 3パターン、キーワード使用、difficulty等 | 496-516 |
| 7 | チェックリスト | 最終確認用のチェック項目 | 544-545 |
| 8 | JSON出力形式 | 厳格なJSONスキーマ指定 | 547-585 |
| 9 | スコア基準 | 5軸評価の説明（厳しめ、平均3点） | 587-592 |
| 10 | 3パターン差別化 | バランス/論理/熱意の3パターン指示 | 594-597 |

### 7.5.5 プロンプトエンジニアリング技法

#### 1. ロールベースプロンプティング

```
＃あなたは{role}である。以下の条件で完璧な{target}に添削して変更せよ。
```

- 各テンプレートに専門家ロールを設定（例: 「就活ESの志望理由作成のプロフェッショナル」）
- 「完璧な」「変更せよ」で高品質・積極的な改善を促す

#### 2. 制約の強調（マーカー使用）

```
【最重要: 文字数厳守】
【JSON出力形式 - 厳守】
```

- 重要な制約に【】マーカーを使用
- 「厳守」「必ず」等の強い表現で遵守率を向上

#### 3. 自己検証指示

```
各パターンを出力する前に、以下の手順を必ず実行:
1. 文章を仮作成
2. len(text) で文字数を計算
3. 範囲外なら調整
4. 再度 len(text) で確認
5. 範囲内になったら char_count に正確な文字数を記録
```

- LLMに自己検証ステップを明示
- Pythonの`len()`関数を具体的に指定

#### 4. JSON出力厳格化

```
# 以下の制約を必ず守ること:
1. JSONオブジェクトのみを出力（マークダウン、説明文、```コードブロック禁止）
2. { で始まり } で終わる（前後に何も付けない）
3. 全ての文字列は必ずダブルクォート（"）で囲む
4. 文字列内の改行は \n、タブは \t でエスケープ
5. 配列・オブジェクトの最後の要素にカンマを付けない
6. strengthen_points は空配列 [] でも必ず含めること
```

- 6つの明示的なルールでJSON出力エラーを防止
- コードブロック禁止を明記（パース失敗の主因）

#### 5. 3パターン差別化

```
- パターン1: バランス重視（読みやすさと具体性のバランス）
- パターン2: 論理重視（因果関係を明確にした構成）
- パターン3: 熱意重視（意欲や passion を強調）
```

- 多様な選択肢を提供
- ユーザーの好みに合わせた選択が可能

### 7.5.6 RAG統合パターン

#### RAGあり時

```
【企業RAG資料】
以下はこの企業に関する資料です。キーワードや企業特徴の参照に使用してください。

{rag_context}

【出典一覧】
- S1: [recruitment] 当社は○○を重視しており...
- S2: [corporate_ir] 今期の重点施策として...
```

#### RAGなし時（企業情報なしモード）

```
【企業情報なしモード】
この企業のRAGデータがないため、以下の点に注意して添削してください:
- 企業キーワードは使用せず、variants の keywords_used と keyword_sources は空配列で出力
- 志望理由系テンプレートでは、「企業研究のヒント」として調べるべきポイントを
  top3 の suggestion に含める
- 応募者自身の経験・価値観・成長目標を軸にした説得力のある構成を重視
```

### 7.5.7 バリデーション（出力検証）

`validate_template_output` 関数（es_templates.py:620-689）が出力を検証:

| チェック項目 | 条件 | エラー時の処理 |
|-------------|------|---------------|
| パターン数 | 3件必須 | リトライ |
| 文字数上限 | char_max以下 | 超過分を報告しリトライ |
| 文字数下限 | char_min以上 | 不足分を報告しリトライ |
| キーワード数 | keyword_count個 | リトライ |
| キーワード出現 | 各1回のみ | リトライ |
| 文体 | だ・である調 | です/ます検出でリトライ |
| char_count正確性 | len(text)と一致 | 自動修正 |

### 7.5.8 テンプレート定義データ構造

**TEMPLATE_DEFS（es_templates.py:15-75）:**

```python
TEMPLATE_DEFS = {
    "template_id": {
        "label": "表示名",
        "keyword_count": 0-2,           # 企業キーワード使用数
        "require_strengthen_points": bool,  # 強化ポイント提案
        "requires_company_rag": bool,   # 企業RAG必須
        "description": "テンプレートの説明",
        "extra_fields": ["intern_name"] # オプションフィールド
    }
}
```

**TEMPLATE_PROMPTS（es_templates.py:78-345）:**

```python
TEMPLATE_PROMPTS = {
    "template_id": {
        "role": "専門家ロール名",
        "target": "添削対象名",
        "aspects": "■ 評価観点1\n・項目1\n・項目2\n...",
        "checklist": "□ チェック項目1\n□ チェック項目2\n..."
    }
}
```

---

## 8. プロンプト仕様（テンプレ添削）

### 共通構造

```
＃あなたは{role}である。以下の条件で完璧な{target}に添削して変更せよ。

【条件】
文字数：{min_chars}字〜{max_chars}字（Python len() でカウント・厳守）
業界：{industry}
企業：{company}
インターン名：{intern_name}  ※インターン系テンプレートのみ
職種・コース名：{role_name}  ※職種・コーステンプレートのみ
設問：{question}

【添削の観点】
{aspects}

【出力要件】
・改善案を3パターン提示し、それぞれのメリット・デメリットを説明
・使用したキーワードがどの資料から取ったものか明記
・強化すべきポイントを企業の求める人材像と照らし合わせて指摘
・Pythonのlen()でカウントし、各ESが指定の文字数になるまで調整を続け、完成後に出力

【チェックリスト】
{checklist}

【JSON出力形式】
{json_format}

【スコア基準（厳しめに付ける、平均3点程度）】
- logic (論理): 主張と根拠の一貫性
- specificity (具体性): 数字・エピソードの充実度
- passion (熱意): 意欲・モチベーションの伝わり度
- company_connection (企業接続): 企業との接点の明確さ（RAGあり時のみ）
- readability (読みやすさ): 文章の流れと理解しやすさ

【3パターンの差別化】
- パターン1: バランス重視（読みやすさと具体性のバランス）
- パターン2: 論理重視（因果関係を明確にした構成）
- パターン3: 熱意重視（意欲や passion を強調）
```

### User Prompt

```
【添削前の{target}】
{answer}

【企業RAG資料】※RAGあり時のみ
以下はこの企業に関する資料です。キーワードや企業特徴の参照に使用してください。

{rag_context}

【出典一覧】
{source_refs}

上記の回答を添削し、3パターンの改善案をJSON形式で出力してください。
```

---

## 9. テンプレート別プロンプト詳細

### 9.1 汎用ES添削（basic）

**添削の観点:**
```
■ 設問への適合性
・設問の意図を正確に理解し、直接的な回答になっているか
・設問で求められている要素（理由、経験、目標等）が網羅されているか
・設問の指示（具体的に、簡潔に等）に従っているか

■ 企業理解・整合性
・企業が重視するキーワードが適切に2つ含まれているか
・企業が重視するキーワードが過剰（3つ以上）に含まれていないか
・企業の事業戦略・方向性・理念との整合性があるか
・競合他社との差別化ができているか

■ 自己アピール
・自分の経験・スキル・価値観と企業の接点が明確か
・抽象的な表現（「成長したい」「挑戦したい」）を具体化しているか
・具体的な数字やエピソードで裏付けているか
・学生らしい成長意欲と学習姿勢が表現されているか

■ 論理性・説得力
・主張と根拠が論理的に繋がっているか
・「なぜ」が明確に説明されているか
・読み手が納得できる内容か

■ 文章構成
・結論ファーストで書かれていて、読み手に伝えたいことが明確に伝わるか
・だ・である調で統一されているか
・冗長な部分や、省略しすぎて伝わりにくい部分はないか
・面接で深掘りされた時に答えられる内容か
```

**チェックリスト:**
```
□ 設問への直接的な回答になっている
□ 企業研究に基づく具体的なキーワード2つ
□ 自分の経験・強みとの接点が明確
□ 論理的で説得力のある構成
□ だ・である調で統一
□ 指定文字数の範囲内
```

---

### 9.2 企業志望理由（company_motivation）

**添削の観点:**
```
■ 企業理解・整合性
・企業が重視するキーワードが適切に2つ含まれているか
・企業が重視するキーワードが過剰（3つ以上）に含まれていないか
・企業の事業戦略・方向性・理念との整合性があるか
・競合他社との明確な差別化ができているか（なぜこの企業でなければならないか）

■ 自己アピール
・自分の経験・スキル・価値観と企業の接点が明確か
・抽象的な表現（「成長したい」「挑戦したい」）を具体化しているか
・学生らしい成長意欲と学習姿勢が表現されているか

■ キャリアビジョン
・入社後に何をしたいかが具体的に示されているか
・キャリアビジョンと企業の事業・キャリアパスが接続されているか

■ 文章構成
・結論ファーストで書かれていて、読み手に伝えたいことが明確に伝わるか
・だ・である調で統一されているか
・冗長な部分や、省略しすぎて伝わりにくい部分はないか
・面接で深掘りされた時に答えられる内容か
```

**チェックリスト:**
```
□ 「貴社でなければならない理由」が明確
□ 企業研究に基づく具体的なキーワード2つ
□ 自分の経験と企業の接点
□ 入社後の具体的なビジョン
```

---

### 9.3 インターン志望理由（intern_reason）

**追加条件:** `インターン名：{intern_name}`

**添削の観点:**
```
■ インターン理解
・このインターンでしか得られない価値・経験を示しているか
・インターンプログラムの内容を正確に理解しているか
・他社インターンとの差別化ができているか

■ 自己との接続
・自分の現状の課題・不足点を認識しているか
・インターンでの成長イメージが具体的か
・自分の強み・素養がどう活きるか示しているか

■ 志望度・意欲
・企業への興味・関心が伝わるか
・本選考への接続を意識した内容か
・受け身でなく主体的な姿勢が見えるか

■ 文章構成
・設問への直接的な回答になっているか
・結論ファーストで書かれているか
・だ・である調で統一されているか
・簡潔で読みやすい文章か
・面接で深掘りされた時に答えられる内容か
```

**チェックリスト:**
```
□ このインターンでしか得られない価値が明確
□ 自分の課題と成長イメージの接続
□ 主体的な姿勢・意欲
□ 設問への直接的な回答
```

---

### 9.4 インターンでやりたいこと（intern_goals）

**追加条件:** `インターン名：{intern_name}`

**添削の観点:**
```
■ 目標の明確性
・やりたい仕事・業務領域が具体的に絞られているか（1〜2つ）
・経験したいことが明確か
・身につけたいことが具体的か
・そう考えた理由が論理的に説明されているか

■ 企業・インターンとの整合性
・企業が重視するキーワードが適切に2つ含まれているか
・企業が重視するキーワードが過剰（3つ以上）に含まれていないか
・企業の事業戦略・方向性との整合性があるか
・インターンプログラムの内容と目標が合致しているか
・競合他社との差別化ができているか

■ 自己との接続
・自分の経験・スキルと目標の接点が明確か
・インターン後のキャリアビジョンとの関連性があるか
・学生らしい成長意欲と学習姿勢が表現されているか

■ 文章構成
・結論ファーストで書かれていて、読み手に伝えたいことが明確に伝わるか
・だ・である調で統一されているか
・冗長な部分や、省略しすぎて伝わりにくい部分はないか
・面接で深掘りされた時に答えられる内容か
```

**チェックリスト:**
```
□ 目標が1〜2つに絞られている
□ 企業の事業・プログラムとの接続
□ 自分の経験との接点が明確
□ 目標達成後のビジョン
□ 受け身でなく主体的な姿勢
```

---

### 9.5 ガクチカ（gakuchika）

**添削の観点:**
```
■ STAR形式の充実度
・Situation（状況）：活動期間、役割、人数等の具体的なイメージができるか
・Task（課題）：取り組んだ課題・目標が明確か
・Action（行動）：自分の役割と主体的な行動が明確か
・Result（結果）：具体的な成果・数字が示されているか

■ 企業適合性
・企業が重視する能力・スキルがアピールできているか
・企業文化・価値観との適合性があるか
・入社後の活躍イメージが想起できるか

■ 差別化・独自性
・他の応募者との差別化ができているか
・自分ならではの視点・工夫があるか
・再現性のある強みとして伝わるか

■ 学び・成長
・具体的な学びが示されているか
・その経験から得た強みが明確か
・企業で活かせる強みとして伝わるか

■ 文章構成
・結論ファーストで書かれているか
・だ・である調で統一されているか
・冗長な部分がないか
・面接で深掘りされた時に答えられる内容か
```

**チェックリスト:**
```
□ 活動期間・役割・人数が明記されている
□ 課題・目標が明確
□ 主体的な行動・工夫が具体的
□ 成果が数字で示されている
□ 学び・得た強みが明確
□ 企業で活かせる強みとして伝わる
```

---

### 9.6 入社後やりたいこと（post_join_goals）

**添削の観点:**
```
■ ビジョンの具体性
・短期（1-3年）と中長期のキャリアビジョンが区別されているか
・具体的なプロジェクト・事業・目標に言及しているか
・「何を」「どのように」「なぜ」が明確か

■ 企業との整合性
・企業が重視するキーワードが適切に2つ含まれているか
・企業が重視するキーワードが過剰（3つ以上）に含まれていないか
・企業の事業戦略・成長領域との整合性があるか
・企業のキャリアパス・研修制度と接続しているか
・実現可能性のあるビジョンか

■ 自己との接続
・自分の強み・経験がどう活きるかを説明しているか
・なぜそのビジョンを持つに至ったか（原体験）が示されているか
・成長意欲・学習姿勢が表現されているか

■ 貢献意識
・企業・社会への貢献イメージが示されているか
・受け身でなく主体的な姿勢か
・独りよがりでなくチームでの協働意識があるか

■ 文章構成
・結論ファーストで書かれているか
・だ・である調で統一されているか
・冗長な部分がないか
・面接で深掘りされた時に答えられる内容か
```

**チェックリスト:**
```
□ 短期・中長期のビジョンが明確
□ 企業の事業・キャリアパスと接続
□ 自分の強み・経験との接点
□ 具体的なプロジェクト・目標への言及
□ 企業・社会への貢献イメージ
```

---

### 9.7 職種・コース選択理由（role_course_reason）

**追加条件:** `職種・コース名：{role_name}`

**添削の観点:**
```
■ 職種理解
・その職種・コースの役割・業務内容を正確に理解しているか
・企業におけるその職種の特徴・強みを把握しているか
・他職種との違いを理解しているか

■ 自己との接続
・なぜその職種なのかを自分の経験と接続しているか
・職種で求められるスキルと自分の素養の接点があるか
・その職種を志望するに至った原体験があるか

■ キャリアビジョン
・その職種でのキャリアビジョンが明確か
・企業のキャリアパスとの整合性があるか
・長期的な成長イメージが示されているか

■ 適性アピール
・その職種に向いている理由が示されているか
・具体的なエピソードで適性を裏付けているか
・入社後の活躍イメージが想起できるか

■ 文章構成
・結論ファーストで書かれているか
・だ・である調で統一されているか
・冗長な部分がないか
・面接で深掘りされた時に答えられる内容か
```

**チェックリスト:**
```
□ 自分の経験と職種の接点が明確
□ 企業のその職種の特徴との接点
□ 職種で求められるスキルと自分の素養
□ その職種でのキャリアビジョン
□ 具体的なエピソードで適性を裏付け
```

---

### 9.8 働く価値観（work_values）

**添削の観点:**
```
■ 価値観の具体性
・抽象的な価値観を具体的な行動指針に落とし込んでいるか
・その価値観を形成した具体的なエピソードがあるか
・一貫性のある価値観として伝わるか

■ 裏付け
・その価値観を裏付ける経験・エピソードがあるか
・実際の行動として表れている例があるか
・複数の場面で発揮された価値観か

■ 仕事への接続
・その価値観が仕事でどう活きるか示しているか
・企業の価値観・文化との親和性があるか
・チームでの協働における意義が示されているか

■ 独自性
・他の応募者との差別化ができているか
・自分ならではの視点・表現があるか
・深みのある内容か

■ 文章構成
・結論ファーストで書かれているか
・だ・である調で統一されているか
・冗長な部分がないか
・面接で深掘りされた時に答えられる内容か
```

**チェックリスト:**
```
□ 具体的なエピソードから価値観を導出
□ 抽象→具体への落とし込み
□ 価値観が仕事でどう活きるか
□ 企業文化との親和性
□ 自分ならではの視点・表現
```

---

## 10. JSON出力形式

```json
{
  "scores": {
    "logic": 1-5の整数,
    "specificity": 1-5の整数,
    "passion": 1-5の整数,
    "company_connection": 1-5の整数または省略,
    "readability": 1-5の整数
  },
  "top3": [
    {
      "category": "評価軸名",
      "issue": "問題点",
      "suggestion": "改善提案",
      "difficulty": "easy" | "medium" | "hard"
    }
  ],
  "rewrites": ["パターン1の本文", "パターン2の本文", "パターン3の本文"],
  "template_review": {
    "template_type": "company_motivation",
    "variants": [
      {
        "text": "改善案の本文",
        "char_count": 文字数（整数）,
        "pros": ["メリット1", "メリット2"],
        "cons": ["デメリット1"],
        "keywords_used": ["キーワード1", "キーワード2"],
        "keyword_sources": ["S1", "S2"]
      }
    ],
    "keyword_sources": [
      {"source_id": "S1", "source_url": "URL", "content_type": "種別", "excerpt": "抜粋"}
    ],
    "strengthen_points": ["強化ポイント1"]
  }
}
```

### difficulty フィールド

| 値 | 説明 | UI表示例 |
|-----|------|---------|
| easy | 簡単に修正可能 | 緑バッジ |
| medium | 中程度の修正 | 黄バッジ |
| hard | 大幅な修正が必要 | 赤バッジ |

---

## 11. バリデーション

### チェック項目
- `variants` は**必ず3件**
- 文字数制限（min/max）- Python `len()` でカウント
- 企業キーワード数・出現回数（1回のみ）
- です/ます調禁止（だ・である調に統一）

### リトライ
- 最大3回
- 文字数下限違反の場合は JSON修復プロンプトで1回補正

---

## 12. LLM 呼び出し & JSONパース

**ファイル:** `backend/app/utils/llm.py`

### モデル選択
- `feature="es_review"` → Claude Sonnet
- APIキー不足時は OpenAI（gpt-5-mini）へフォールバック

### LLM呼び出しパラメータ

| モード | max_tokens | temperature |
|-------|-----------|-------------|
| 全文添削 | 3000 | 0.3 |
| 設問添削（非テンプレ） | 2000 | 0.3 |
| テンプレ添削 | 4500 | 0.4 |
| JSON修復 | 2000 | 0.2 |

### JSONパース手順
1. 直接 `json.loads`
2. 文字列内の改行/タブをエスケープ
3. ```json ブロック抽出
4. ``` ブロック抽出
5. 正規表現で `{...}` 抽出

---

## 13. 失敗時の挙動

| 状況 | HTTPステータス | エラータイプ |
|-----|---------------|-------------|
| LLM応答がJSONでない | 503 | parse |
| テンプレ出力が検証不合格 | 422 | validation |
| Claude/OpenAIの課金・レート制限 | 503 | rate_limit / billing |
| 開発環境のみ | - | mock reviewへフォールバック |

---

## 14. 代表ログ

- `[LLM] Calling claude-sonnet (...) for feature: es_review`
- `[LLM] JSON parse failed. Content preview: ...`
- `[ES Review] Fetched enhanced RAG context (xxxx chars)`
- `[ES Review] RAG status: X total chunks (recruitment: X, corporate_ir: X, ...)`
- `[Template Review] Attempt 1/3 for template post_join_goals`
- `[Template Review] Validation failed on attempt 1: パターン1: 下限300文字未満`
- `[Template Review] Success on attempt 2`

---

## 15. 関連ファイル

| ファイル | 役割 |
|---------|-----|
| `backend/app/routers/es_review.py` | FastAPI Router（メインロジック） |
| `backend/app/prompts/es_templates.py` | テンプレート定義 & プロンプトビルダー |
| `backend/app/utils/llm.py` | LLM呼び出し & JSONパース |
| `backend/app/utils/vector_store.py` | RAGコンテキスト取得 |
| `backend/app/utils/hybrid_search.py` | ハイブリッド検索 |
| `src/app/api/documents/[id]/review/route.ts` | Next.js API（認証・クレジット） |
| `src/hooks/useESReview.ts` | フロントエンドフック |
| `src/components/es/ReviewPanel.tsx` | 添削結果表示パネル |
| `src/components/es/ImprovementList.tsx` | 改善点リスト（カテゴリ色分け） |
| `templates/*.md` | プロンプトテンプレート原本 |
| `docs/SPEC.md` | 全体仕様書 |

---

## 16. 問題分析と改善履歴

### 16.1 テンプレート添削失敗問題（2026-01）

**症状**: テンプレートを選択した場合のみ503エラー（非テンプレートは成功）

```
[ES添削] ❌ OpenAI フォールバック失敗: Error code: 400 -
{'error': {'message': "Invalid schema for response_format 'es_review_response':
In context=('properties', 'template_review', 'properties', 'keyword_sources', 'items'),
'required' is required to be supplied and to be an array including every key in properties.
Missing 'excerpt'."}}
```

#### 根本原因分析

| # | 問題 | 原因 | 影響度 |
|---|------|------|--------|
| 1 | OpenAI スキーマ検証エラー | `keyword_source_schema.required`に`excerpt`が不足 | Critical |
| 2 | JSON解析失敗 | レスポンス切り詰め（5697文字）とコードブロックラッピング | High |
| 3 | JSON修復モデル選択 | Haikuでは複雑なJSON構造の修復能力が不足 | Medium |
| 4 | トークン不足 | `max_tokens=4500`でテンプレート3パターン出力に不足 | Medium |

#### 詳細分析

**問題1: OpenAI Structured Outputs スキーマ検証**

OpenAI Structured Outputs（`strict: true`）は、`properties`に定義された全フィールドが`required`に含まれている必要がある。

```python
# 修正前（エラー）
keyword_source_schema = {
    "required": ["source_id", "source_url", "content_type"],  # excerptがない
    "properties": {
        "source_id": {"type": "string"},
        "source_url": {"type": "string"},
        "content_type": {"type": "string"},
        "excerpt": {"type": "string"},  # propertiesにはある
    },
}

# 修正後（正常）
keyword_source_schema = {
    "required": ["source_id", "source_url", "content_type", "excerpt"],  # 追加
    "properties": { ... },
}
```

**問題2: JSON解析失敗**

LLMがJSONを` ```json `コードブロックで出力し、レスポンスが切り詰められた場合に閉じタグ``` がなくなり、解析に失敗。

**問題3: モデル選択**

開発環境で`CLAUDE_MODEL`をHaikuに設定していると、JSON修復もHaikuで実行され、複雑なネスト構造の修復に失敗。

**問題4: トークン不足**

テンプレート添削は3パターン×（本文+メタデータ）を出力するため、`max_tokens=4500`では切り詰めリスクが高い。

#### 実施した対策

| # | 対策 | ファイル | 変更内容 |
|---|------|----------|----------|
| 1 | スキーマ修正 | `es_review.py:296` | `excerpt`を`required`に追加 |
| 2 | スキーマ修正 | `es_review.py:308` | `strengthen_points`を`required`に追加 |
| 3 | トークン増加 | `es_review.py:514` | `max_tokens`を4500→5500に増加 |
| 4 | プロンプト改善 | `es_templates.py:547` | JSON出力制約をより明確化 |
| 5 | 修復モデル変更 | `llm.py:379-391` | JSON修復に常にSonnetを使用 |

#### 改善後のフォールバックフロー

```
1. Claude Sonnet (max_tokens=5500)
   ↓ JSON解析失敗
2. 同一モデルで再試行（厳格なプロンプト）
   ↓ JSON解析失敗
3. Claude Sonnet で JSON修復（常にSonnet）
   ↓ JSON解析失敗
4. OpenAI Structured Outputs（修正済みスキーマ）
   ↓ 全て失敗
5. 503 Service Unavailable
```

#### 今後の改善案

- **部分結果リカバリー**: 完全な結果が得られなくても、解析できた部分で応答を返す
- **テレメトリー強化**: テンプレートタイプ別成功率、トークン切り詰め検出を追加
- **動的トークン調整**: 文字数制限に応じてmax_tokensを動的に調整
